cmake_minimum_required(VERSION 3.10)

# Find ANTLR4 runtime (should have been found by grammar/CMakeLists.txt)
find_package(antlr4-runtime CONFIG)
if(NOT antlr4-runtime_FOUND)
    message(WARNING "antlr4-runtime not found. Tools will not be built.")
    return()
endif()

# Determine which ANTLR4 library to use based on platform
# Windows uses shared library (DLL), Linux uses static library
if(TARGET antlr4_shared)
    set(ANTLR4_LIBRARY antlr4_shared)
    message(STATUS "Using ANTLR4 shared library")
elseif(TARGET antlr4_static)
    set(ANTLR4_LIBRARY antlr4_static)
    message(STATUS "Using ANTLR4 static library")
else()
    message(FATAL_ERROR "Neither antlr4_shared nor antlr4_static targets are available")
endif()

# Get the ANTLR generated code directory
set(ANTLR_OUTPUT_DIR "${CMAKE_BINARY_DIR}/grammar/grammar")

# List the generated source files explicitly (they will be generated by generate-grammar target)
set(ANTLR_GENERATED_SOURCES
    "${ANTLR_OUTPUT_DIR}/WitLexer.cpp"
    "${ANTLR_OUTPUT_DIR}/WitParser.cpp"
    "${ANTLR_OUTPUT_DIR}/WitVisitor.cpp"
    "${ANTLR_OUTPUT_DIR}/WitBaseVisitor.cpp"
)

# Mark the generated sources as GENERATED so CMake doesn't check for them at configure time
set_source_files_properties(${ANTLR_GENERATED_SOURCES} PROPERTIES GENERATED TRUE)

# WIT code generator using ANTLR grammar
add_executable(wit-codegen
    wit-codegen.cpp
    ${ANTLR_GENERATED_SOURCES}
)

# Link against ANTLR4 runtime directly
target_link_libraries(wit-codegen PRIVATE
    ${ANTLR4_LIBRARY}
)

# Add include directories for ANTLR generated code
target_include_directories(wit-codegen PRIVATE
    ${CMAKE_BINARY_DIR}/grammar
    ${VCPKG_INSTALLED_DIR}/${VCPKG_TARGET_TRIPLET}/include/antlr4-runtime
)

# Depend on grammar generation
add_dependencies(wit-codegen generate-grammar)

# Set C++ standard
target_compile_features(wit-codegen PRIVATE cxx_std_17)

